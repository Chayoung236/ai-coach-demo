<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIコーチングデモ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSSはそのまま */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0B1430;
            color: #c9d1d9;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a202c; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5462; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #606b7a; }
        .icon-svg {
            display: inline-block;
            vertical-align: middle;
            width: 20px;
            height: 20px;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon-svg.animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="flex flex-col h-[70vh] max-h-[800px] w-full max-w-4xl mx-auto p-4 bg-gray-900 rounded-xl shadow-lg border border-gray-700">
        <div class="flex justify-between items-center pb-3 mb-4 border-b border-gray-700">
            <h2 class="text-2xl font-bold text-blue-400 flex items-center">
                <svg class="icon-svg mr-2" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                AIコーチングデモ
            </h2>
            <button id="newSessionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 ease-in-out shadow-md hover:shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="icon-svg mr-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                    <path d="M3 21v-5h5"></path>
                </svg>
                新規セッション
            </button>
        </div>

        <div id="messagesContainer" class="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-4 mb-4">
            <div id="initialMessage" class="text-center text-gray-500 py-10">
                <p>AIコーチングを開始します。最初のメッセージを入力してください。</p>
                <p class="text-sm mt-2">（例: 「最近、仕事でモヤモヤしています。」）</p>
            </div>
        </div>

        <div class="flex mt-auto">
            <input
                type="text"
                id="messageInput"
                placeholder="メッセージを入力してください..."
                class="flex-1 p-3 rounded-l-lg bg-gray-800 text-gray-100 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 disabled:opacity-50"
            />
            <button id="sendMessageBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-5 rounded-r-lg transition-all duration-300 ease-in-out shadow-md hover:shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                <svg id="sendIcon" class="icon-svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 2L11 13"></path>
                    <path d="M22 2l-7 19-3-7L2 22z"></path>
                </svg>
                <svg id="loadingIcon" class="icon-svg animate-spin hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>
            </button>
        </div>

        <div id="apiKeyWarning" class="mt-4 p-3 bg-red-800 text-red-200 rounded-lg text-sm text-center hidden">
          <p>AIコーチングは現在利用できません。Vercelの環境変数とコード設定を確認してください。</p>
        </div>
    </div>

    <script>
        // ==============================================================================
        // JavaScriptロジック (UI操作とサーバーへの通信のみ)
        // ==============================================================================

        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const sendIcon = document.getElementById('sendIcon');
        const loadingIcon = document.getElementById('loadingIcon');
        const apiKeyWarning = document.getElementById('apiKeyWarning');
        const initialMessageDiv = document.getElementById('initialMessage');

        let chatHistory = []; // チャット履歴を保持
        let isLoading = false; // AIが応答を生成中かどうかのフラグ
        let isApiConfigured = true; // サーバーエラー時にfalseに変更される想定

        // ★ APIキーのチェックは不要になりました。サーバーレス関数が担当します。

        // ページロード時の初期AIメッセージ表示
        function checkAndDisplayInitialMessage() {
            // サーバー側でエラーがなければ、初期メッセージを表示
            if (isApiConfigured) {
                setTimeout(() => {
                    addMessage({ sender: 'ai', text: "AIコーチングを開始します。今日のあなたのモヤモヤはどんなことですか？" });
                }, 100);
            }
        }

        // ==============================================================================
        // 2. メッセージをDOMに追加する関数 (変更なし)
        // ==============================================================================
        function addMessage(msg) {
            if (!initialMessageDiv.classList.contains('hidden')) {
                initialMessageDiv.classList.add('hidden');
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `flex items-start max-w-[80%] p-3 rounded-lg shadow-md ${
                msg.sender === 'user'
                    ? 'bg-blue-700 text-white rounded-br-none'
                    : 'bg-gray-800 text-gray-100 rounded-bl-none'
            }`;

            if (msg.sender === 'ai') {
                const botIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                botIcon.classList.add('icon-svg', 'flex-shrink-0', 'mr-2', 'text-blue-400');
                botIcon.setAttribute('width', '20');
                botIcon.setAttribute('height', '20');
                botIcon.setAttribute('viewBox', '0 0 24 24');
                botIcon.setAttribute('fill', 'none');
                botIcon.setAttribute('stroke', 'currentColor');
                bot
